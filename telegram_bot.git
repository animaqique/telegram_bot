from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update, InputMediaPhoto, InputMediaVideo
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ 'YOUR_BOT_TOKEN' Ð½Ð° Ñ‚Ð¾ÐºÐµÐ½ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð±Ð¾Ñ‚Ð°
TOKEN = '7422639066:AAFXpir4faa8Rj0mvnsicS79egy3u2l2sco'
# Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ '@your_channel_id' Ð½Ð° Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð²Ð°ÑˆÐµÐ³Ð¾ ÐºÐ°Ð½Ð°Ð»Ð°
CHANNEL_ID = '@abeonatour'

# Ð¥Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸
post_data = {
    "text": "",
    "media": []
}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /prepare Ð´Ð»Ñ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸ Ð¿Ð¾ÑÑ‚Ð° Ð¸ /publish Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸.')

async def prepare(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
    post_data["text"] = ""
    post_data["media"] = []
    await update.message.reply_text('ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿Ð¾ÑÑ‚Ð°.')

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.message.photo:
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
        photo_id = update.message.photo[-1].file_id
        post_data["media"].append(InputMediaPhoto(photo_id))
        await update.message.reply_text('Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿Ð¾ÑÑ‚Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ /publish Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸.')
    elif update.message.video:
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð²Ð¸Ð´ÐµÐ¾
        video_id = update.message.video.file_id
        post_data["media"].append(InputMediaVideo(video_id))
        await update.message.reply_text('Ð’Ð¸Ð´ÐµÐ¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿Ð¾ÑÑ‚Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ /publish Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸.')
    elif update.message.text:
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑÑ‚Ð°
        post_data["text"] = update.message.text
        await update.message.reply_text('Ð¢ÐµÐºÑÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ/Ð²Ð¸Ð´ÐµÐ¾ Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ /publish Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸.')

async def publish(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not post_data["text"] and not post_data["media"]:
        await update.message.reply_text('ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /prepare Ð´Ð»Ñ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸ Ð¿Ð¾ÑÑ‚Ð°.')
        return

    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸
    keyboard = [
        [InlineKeyboardButton("ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð¼Ð½Ðµ ðŸ¤—", url='https://t.me/kris_konovalovaaa')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    # ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ñ‚ÐµÐºÑÑ‚Ð° Ð¸ Ð¼ÐµÐ´Ð¸Ð°
    if post_data["media"]:
        await context.bot.send_media_group(chat_id=CHANNEL_ID, media=post_data["media"])
    if post_data["text"]:
        await context.bot.send_message(chat_id=CHANNEL_ID, text=post_data["text"], reply_markup=reply_markup, parse_mode='MarkdownV2')

    # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ÑÐ»Ðµ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸
    post_data["text"] = ""
    post_data["media"] = []
    await update.message.reply_text('ÐŸÐ¾ÑÑ‚ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½.')

def main() -> None:
    application = Application.builder().token(TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("prepare", prepare))
    application.add_handler(CommandHandler("publish", publish))
    application.add_handler(MessageHandler(filters.PHOTO | filters.VIDEO | filters.TEXT, handle_message))

    application.run_polling()

if __name__ == '__main__':
    main()
